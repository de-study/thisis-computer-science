# 네트워크 계층 - IP

LAN을 넘어서 다른 네트워크와 통신을 주고 받기 위해서 네트워크 계층 이상의 기술이 필요.

가장 핵심 프로토콜이 바로 IP

## IP의 본래 목적

- 주소 지정 (addressing)
    - 네트워크 간의 통신 과정에서 호스트를 특정하는 것을 의미
    - IP주소를 통해 이루어지며, IP 패킷 헤더를 통해 알 수 있음
    - 송신지 IP 주소, 수신지 IP 주소: 송수신지를 식별할 수 있는 IP주소가 명시됨 (10진수 4개로 표시)
        - 옥텟(octet): 4개의 10진수로 표기된 IP주소에서 점으로 구분된 하나의 10진수를 의미
    - 라우터(router)
        - 서로 다른 네트워크에 속한 두 호스트가 네트워크 간 통신을 수행할 때, IP주소를 바탕으로 목적지까지 IP 패킷을 전달하는 네트워크 장비
        - 라우팅: 라우터가 IP 패킷을 전달할 최적의 경로를 결정하고 해당 경로로 패킷을 내보내는 과정
        - 공유기도 라우팅을 수행할 수 있기에 라우터의 일종이라고 볼 수 있음

- 단편화 (fragmentation)
    - 데이터를 여러 IP 패킷으로 올바르게 쪼개어 보내는 것을 의미
    - MTU (Maximum Transmission Unit)
        - 최대 전송 단위를 의미 (1500 바이트)
        - MTU 보다 클 경우 패킷을 MTU 이하의 여러 패킷으로 쪼개서 전송하고, 수신지에서 재조합됨
    - 식별자
        - 특정 패킷이 어떤 데이터에서 쪼개진 패킷인지를 식별하기 위해 사용되는 필드
        - 같은 정보에서 쪼개진 패킷들은 같은 식별자를 공유하기에 식별자를 통해 단편화되어 전송되는 패킷을을 구분할 수 있음
    - 플래그 (flag)
        - 3비트로 구성된 필드로 첫 번째 비트를 제외한 나머지 2개의 비트는 각각 DF와 MF라는 이름이 붙어 있음
            - 첫 번째 비트는 항상 0: 오늘날에는 사용되지 않음
            - DF(Don’t Fragment): IP 단편화를 수행하지 말라는 표시
            - MF(More Fragment): 단편화된 패킷이 더 있다라는 표시
    - 단편화 오프셋 (fragment offset)
        - 특정 패킷이 초기 데이터에서 얼마나 떨어져 있는지가 명시된 필드
        - 단편화되어 전송되는 패킷을 목적지에서 재조합하기 위해 패킷의 올바른 순서를 나타내는데 사용

신뢰할 수 없는 프로토콜과 비연결형 통신

IP는 신뢰할 수 없는 프로토콜이자, 비연결형 프로토콜

- 신뢰할 수 없는 프로토콜
    - 패킷이 수신지까지 제대로 전송되었다고 보장하지 않는 프로토콜
    - 패킷이 유실되거나 목적지에 순서대로 전송되지 않더라도 이에 대한 조치를 취하지 않음
    - 최선형 전달이라고 부름 (어떠한 보장도 하지 않는 전송 특징)
- 비연결형 프로토콜
    - 패킷을 주고받기 전에 사전 연결 과정을 거치지 않는다는 것을 의미
    - 상대 호스트의 수신 가능 여부 고려하지 않고, 수신지를 향해 패킷을 전송함

## IP 주소의 구조

IP주소는 크게 네트워크 주소와 호스트 주소로 이루어져 있다.

- 네트워크 주소
    - 네트워크 식별자, 네트워크 ID 등으로 불림
    - 호스트가 속한 네트워크를 특정하기 위해 사용
- 호스트 주소
    - 호스트 식별자, 호스트 ID 등으로 불림
    - 네트워크에 속한 호스트를 특정하기 위해 사용

하나의 IP 주소에서 네트워크 주소를 표현하는 크기와 호스트를 표현하는 크기가 유동적일 수 있다.

각각의 크기는 상황에 따라 다른데, 이러한 점을 해결하기 위해 IP 주소의 클래스가 있다.

- 클래스: 네트워크의 크기에 따라 유형별로 IP 주소를 분류하는 기준
    - A, B, C, D, E 가 있으며, D, E는 각각 멀티캐스트를 위한 클래스로 실질적으로 사용되는 것은 A, B, C임
        - A 클래스 : 네트워크 주소는 비트 0으로 시작해 1옥텟으로 구성되고, 호스트 주소는 3옥텟으로 구성
        - B 클래스 : 네트워크 주소는 비트 10으로 시작해 2옥텟으로 구성되고, 호스트 주소도 2옥텟으로 구성
        - C 클래스 : 네트워크 주소는 비트 110으로 시작해 3옥텟으로 구성되고, 호스트 주소는 1옥텟으로 구성
    - 클래스풀 주소 체계 : 클래스 바탕으로 IP주소를 관리하는 주소 체계

## 클래스리스 주소 체계와 서브넷 마스크

클래스풀 주소 체계는 클래스별 네트워크 크기가 고정되어 있어 IP주소가 낭비될 수 있다는 한계가 있다.

그래서 더 정교하고 유동적으로 네트워크 영역을 나누기 위해 클래스리스 주소 체계가 등장했다.

- 클래스리스 주소 체계: 클래스를 이용하지 않고, 네트워크와 호스트를 구분하는 방식으로 서브넷 마스크를 이용함
    - 서브넷 마스크: IP 주소상에서 네트워크 주소를 1로 표기하고, 호스트 주소를 0으로 표기한 비트열
    - 서브네트워크: IP 주소에서 네트워크 주소로 구분할 수 있는 네트워크의 부분 집합을 의미 (서브넷이라고 줄여 부름)
    - 서브네팅: 서브넷 마스크를 이용해 원하는 크기로 클래스를 더 잘게 쪼개어 사용하는 것

## 공인 IP 주소와 사설 IP 주소

호스트의 IP 주소는 네트워크 설정이나 명령어를 통해서 확인할 수 있고 온라인 검색을 통해 확인할 수 있다.

하지만 이 경우 전자와 후자의 IP 주소는 다르게 나오는 것을 확인할 수 있다.

이유는 IP주소에는 고유한 IP주소도 있고, 고유하지 않은 IP주소가 있기 때문이다.

- 공인 IP 주소
    - 고유한 IP 주소
    - 인터넷을 비롯한 네트워크 간 통신에서 사용되는 IP 주소

- 사설 IP 주소
    - 고유하지 않은 IP 주소
    - 사설 네트워크에서 사용하기 위한 IP 주소
    - 일반적으로 라우터를 통해 할당되기에 공유기(라우터)를 중심으로 구성된 LAN 대부분은 사설 네트워크에 해당함
    - 해당 호스트가 속한 네트워크상에서만 유효한 주소로 중복될 수도 있음

## IP 주소의 할당

- 정적 할당
    - 직접 수작업으로 IP주소를 부여하는 방식 → 할당된 IP 주소를 정적 IP 주소라고 함
    - IP 주소, 서브넷 마스크, 게이트웨이 (라우터) 주소, DNS 주소 등이 필요함
    - 게이트웨이: 일반적으로 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단
    - 기본 게이트웨이
        - 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로
        - 네트워크 외부와 연결된 라우터(공유기)의 주소를 의미하는 경우가 많음
    - DNS 주소: 호스트가 도메인 네임을 토대로 IP 주소를 알아내기 위해 질의하는 서버의 주소

- 동적 할당
    - 프로토콜을 통해 자동으로 IP 주소를 부여하는 방식 → 할당된 IP 주소를 동적 IP 주소라고 함
    - 가장 흔히 사용되는 프로토콜: DHCP (Dynamic Host Configuration Protocol)
    - IP 주소를 동적으로 할당받고자 하는 호스트는 DHCP 서버와 메시지를 주고받으며 동적 IP주소를 할당 받을 수 있음
        - DHCP 서버: 호스트에 할당 가능한 IP주소 목록을 관리하다가, IP주소 할당 요청을 받았을 때 IP주소를 할당해주는 호스트
    - 동적 IP주소에는 사용 가능한 기간이 정해져 있음
    - 동적 IP주소는 할당받을 때마다 다른 주소를 받을 수 있음

## IP전송 특징의 보완: ICMP

IP의 신뢰할 수 없는 비연결형 통신이라는 특징은 반드시 극복해야 할 단점은 아니지만 보완해야 할 때가 있다.

이를 위한 방법으로 네트워크 계층의 프로토콜로 ICMP를 이용하는 방법

ICMP(Internet Control Message Protocol)

- IP 패킷의 전송 과정에 대한 피드벡 메시지(ICMP 메시지)를 얻기 위해 사용하는 프로토콜
- ICMP 메시지를 통해 패킷이 상대방에게 어떻게 전송 되었는지를 알려줄 수 있어 IP 전송의 결과를 엿볼 수 있음
- IP 의 신뢰성을 완전히 보장하지는 않음

ICMP 메시지 종류

- 전송 과정에서 발생한 오류 보고
- 네트워크 도달 불가 (Destination network unreachable)
- 호스트 도달 불가 (Destination host unreachable)
- 프로토콜 도달 불가, 수신지에서 특정 프로토콜을 사용할 수 없음 (Destination protocol unreachable)
- 포트 도달 불가 (Destination port unreachable)
- 단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음 (Fragmentation required, and DF flag set)
- TTL 만료 (TTL expired in transit)

네트워크에 대한 진단 정보

- Echo 요청 (Echo request)
- Echo 응답 (Echo reply)

## IP주소와 MAC 주소의 대응: ARP

패킷의 송수신 과정에서도 IP 주소와 MAC 주소를 함께 사용하지만 IP주소를 우선적으로 활용한다.

이 때 상대 호스트의 IP 주소만 알고, MAC 주소를 모르는 상황이 있을 수 있는데, 해당 상황에서 ARP라는 프로토콜이 사용된다.

- ARP (Address Resolution Protocol)
    - IP 주소와 MAC 주소를 함께 활용하는 통신 과정에서 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아내는 프로토콜
    - MAC 주소를 알아내는 과정은 ARP 요청 메시지와 ARP 응답 메시지를 통해 이루어짐
    - APR 요청 메시지인 브로드캐스트 메시지를 전송 → 네트워크 내 모든 호스트가 수신 → 호스트들은 IP 주소를 확인 → 자신의 IP 주소의 경우 ARP 응답 메시지 전송 (MAC 주소 포함)
    - ARP 테이블 : <IP주소, MAC주소>의 항목들로 구성된 표 형태의 정보로 ARP를 활용하는 호스트는 해당 정보를 유지함
